#include "boi_wifi.h"
#include <HTTPClient.h>

const char rootCACertificate[] = {"-----BEGIN CERTIFICATE-----" \
"MIIDujCCAqKgAwIBAgILBAAAAAABD4Ym5g0wDQYJKoZIhvcNAQEFBQAwTDEgMB4G" \
"A1UECxMXR2xvYmFsU2lnbiBSb290IENBIC0gUjIxEzARBgNVBAoTCkdsb2JhbFNp" \
"Z24xEzARBgNVBAMTCkdsb2JhbFNpZ24wHhcNMDYxMjE1MDgwMDAwWhcNMjExMjE1" \
"MDgwMDAwWjBMMSAwHgYDVQQLExdHbG9iYWxTaWduIFJvb3QgQ0EgLSBSMjETMBEG" \
"A1UEChMKR2xvYmFsU2lnbjETMBEGA1UEAxMKR2xvYmFsU2lnbjCCASIwDQYJKoZI" \
"hvcNAQEBBQADggEPADCCAQoCggEBAKbPJA6+Lm8omUVCxKs+IVSbC9N/hHD6ErPL" \
"v4dfxn+G07IwXNb9rfF73OX4YJYJkhD10FPe+3t+c4isUoh7SqbKSaZeqKeMWhG8" \
"eoLrvozps6yWJQeXSpkqBy+0Hne/ig+1AnwblrjFuTosvNYSuetZfeLQBoZfXklq" \
"tTleiDTsvHgMCJiEbKjNS7SgfQx5TfC4LcshytVsW33hoCmEofnTlEnLJGKRILzd" \
"C9XZzPnqJworc5HGnRusyMvo4KD0L5CLTfuwNhv2GXqF4G3yYROIXJ/gkwpRl4pa" \
"zq+r1feqCapgvdzZX99yqWATXgAByUr6P6TqBwMhAo6CygPCm48CAwEAAaOBnDCB" \
"mTAOBgNVHQ8BAf8EBAMCAQYwDwYDVR0TAQH/BAUwAwEB/zAdBgNVHQ4EFgQUm+IH" \
"V2ccHsBqBt5ZtJot39wZhi4wNgYDVR0fBC8wLTAroCmgJ4YlaHR0cDovL2NybC5n" \
"bG9iYWxzaWduLm5ldC9yb290LXIyLmNybDAfBgNVHSMEGDAWgBSb4gdXZxwewGoG" \
"3lm0mi3f3BmGLjANBgkqhkiG9w0BAQUFAAOCAQEAmYFThxxol4aR7OBKuEQLq4Gs" \
"J0/WwbgcQ3izDJr86iw8bmEbTUsp9Z8FHSbBuOmDAGJFtqkIk7mpM0sYmsL4h4hO" \
"291xNBrBVNpGP+DTKqttVCL1OmLNIG+6KYnX3ZHu01yiPqFbQfXf5WRDLenVOavS" \
"ot+3i9DAgBkcRcAtjOj4LaR0VknFBbVPFd5uRHg5h6h+u/N5GJG79G+dwfCMNYxd" \
"AfvDbbnvRG15RjF+Cv6pgsH/76tuIMRQyV+dTZsXjAzlAcmgQWpzU/qlULRuJQ/7" \
"TBj0/VLZjmmx6BEP3ojY+x1J96relc8geMJgEtslQIxq/H5COEBkEveegeGTLg==" \
"-----END CERTIFICATE-----"
};

pthread_mutex_t https_lock;
HTTPClient https;

void send_post_to_battery_internet(const uint8_t *message, unsigned int length){
    uint8_t *Data;

    if(!_globalBoiWifi || !(Mode == boi_wifi::SafeModeWithNetworking) || (WiFi.status() != WL_CONNECTED))
        return;

    pthread_mutex_lock(&https_lock);

    //can send the message
    Serial.print("[HTTPS] begin...\n");
    if (https.begin("https://batteryinter.net/battery.php", rootCACertificate)) {  // HTTPS
        Serial.printf("[HTTPS] POSTing %d bytes...\n", length + 17);

        // start connection and send HTTP data
        Data = (uint8_t *)malloc(length + 17);
        if(!Data)
        {
            printf("Out of memory\n");
            return;
        }

        memcpy(Data, WiFi.macAddress().c_str(), 17);
        memcpy(&Data[17], message, length);
    
        //content length unneeded, auto added by POST
        https.addHeader("Content-Type", "text/plain");
        int httpCode = https.POST(Data, length + 17);
        free(Data);

        // httpCode will be negative on error
        if (httpCode > 0) {
            // HTTP header has been send and Server response header has been handled
            Serial.printf("[HTTPS] POST... code: %d\n", httpCode);

            // file found at server
            if (httpCode == HTTP_CODE_OK) {
                Serial.println("[HTTPS] POST complete");
            }
        } else {
            Serial.printf("[HTTPS] POST... failed, error: %s\n", https.errorToString(httpCode).c_str());
        }

        https.end();
    } else {
        Serial.printf("[HTTPS] Unable to connect\n");
        https.end();
    }

    pthread_mutex_unlock(&https_lock);
}

void do_battery_checkin(){
    uint8_t *Data;

    if(!_globalBoiWifi || !(Mode == boi_wifi::SafeModeWithNetworking) || (WiFi.status() != WL_CONNECTED))
        return;

    pthread_mutex_lock(&https_lock);

    //can send the message
    Serial.print("[HTTPS] begin...\n");
    if (https.begin("https://batteryinter.net/checkin", rootCACertificate)) {  // HTTPS
        Serial.println("[HTTPS] POSTing to checkin...");

        // start connection and send HTTP data
        Data = (uint8_t *)malloc(17 + 15);
        if(!Data)
        {
            printf("Out of memory\n");
            return;
        }

        String LocalIP = WiFi.localIP().toString();
        memcpy(Data, WiFi.macAddress().c_str(), 17);
        memcpy(&Data[17], LocalIP.c_str(), LocalIP.length());
    
        //content length unneeded, auto added by POST
        https.addHeader("Content-Type", "text/plain");
        int httpCode = https.POST(Data, LocalIP.length() + 17);
        free(Data);

        // httpCode will be negative on error
        if (httpCode > 0) {
            // HTTP header has been send and Server response header has been handled
            Serial.printf("[HTTPS] POST... code: %d\n", httpCode);

            // file found at server
            if (httpCode == HTTP_CODE_OK) {
                Serial.println("[HTTPS] POST complete");
            }
        } else {
            Serial.printf("[HTTPS] POST... failed, error: %s\n", https.errorToString(httpCode).c_str());
        }

        https.end();
    } else {
        Serial.printf("[HTTPS] Unable to connect\n");
        https.end();
    }

    pthread_mutex_unlock(&https_lock);
}